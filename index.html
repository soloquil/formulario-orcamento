// Orçamento Vinicius Barbaro Films

import React, { useState, useEffect } from "react";
import Papa from "papaparse";
import { Button } from "@/components/ui/button";

const SERVICE_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSU-fqjBfA2H6XvQl7iQj04dVs3ZcpLBpfe1oDshpchCKwM5xA2YDnDo3aErtDjH0C3rq0FjxljUkjo/pub?output=csv";
const MULTIPLIERS_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTF9euiuflgr2u9eUDoI5WU11uL_d5IqOKbDc7VkidEifW_FdUId4T11Qg2gHwv4kodMfTqHqEwYGm3/pub?output=csv";
const VIDEO_EDIT_TYPES_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIYHSrb2-VHg1v-OnkmwKjBAkksm3x1JB2YUuJbl-UIMcNVOdRnqXsChw0koVOJCEDfufYQDLfVPPy/pub?output=csv";
const VIDEO_ADDITIONALS_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBtaad2hZAfvpdIM3L12m9Pgq7hm_OCEC9AgxW6anYUuuPOPAQ1Cjfc89LtMmRQpHHapS3um71eeQU/pub?output=csv";

export default function Orcamento() {
  const [services, setServices] = useState([]);
  const [multipliers, setMultipliers] = useState({});
  const [videoEditTypes, setVideoEditTypes] = useState([]);
  const [videoAdditionals, setVideoAdditionals] = useState([]);
  const [selectedServices, setSelectedServices] = useState({});
  const [selectedVideoEdits, setSelectedVideoEdits] = useState([]);
  const [selectedVideoAdditionals, setSelectedVideoAdditionals] = useState([]);
  const [providerCount, setProviderCount] = useState(1);
  const [isFilmingSelected, setIsFilmingSelected] = useState(false);

  useEffect(() => {
    Papa.parse(SERVICE_URL, {
      download: true,
      header: true,
      complete: (results) => setServices(results.data),
    });

    Papa.parse(MULTIPLIERS_URL, {
      download: true,
      header: true,
      complete: (results) => {
        const data = {};
        results.data.forEach((row) => {
          const key = row["Número de Fornecedores"];
          data[key] = parseFloat(row["Multiplicador"]);
        });
        setMultipliers(data);
      },
    });

    Papa.parse(VIDEO_EDIT_TYPES_URL, {
      download: true,
      header: true,
      complete: (results) => setVideoEditTypes(results.data),
    });

    Papa.parse(VIDEO_ADDITIONALS_URL, {
      download: true,
      header: true,
      complete: (results) => setVideoAdditionals(results.data),
    });
  }, []);

  const handleServiceToggle = (serviceName) => {
    const updated = { ...selectedServices };
    if (updated[serviceName]) {
      delete updated[serviceName];
    } else {
      updated[serviceName] = true;
    }
    setSelectedServices(updated);
    setIsFilmingSelected("Filmagem" in updated);
  };

  const handleVideoEditToggle = (type) => {
    const updated = [...selectedVideoEdits];
    const idx = updated.indexOf(type);
    if (idx > -1) {
      updated.splice(idx, 1);
    } else {
      updated.push(type);
    }
    setSelectedVideoEdits(updated);
  };

  const handleVideoAdditionalToggle = (service) => {
    const updated = [...selectedVideoAdditionals];
    const idx = updated.indexOf(service);
    if (idx > -1) {
      updated.splice(idx, 1);
    } else {
      updated.push(service);
    }
    setSelectedVideoAdditionals(updated);
  };

  const calculateTotal = () => {
    const multiplier = multipliers[providerCount] || 1;
    let total = 0;

    services.forEach((service) => {
      if (selectedServices[service["Serviço"]]) {
        const base = parseFloat(service["8h"] || 0); // Exemplo: usar 8h como base
        total += base * multiplier;
      }
    });

    videoEditTypes.forEach((type) => {
      if (selectedVideoEdits.includes(type["Tipo de Vídeo"])) {
        total += parseFloat(type["Valor"] || 0);
      }
    });

    videoAdditionals.forEach((add) => {
      if (selectedVideoAdditionals.includes(add["Serviço"])) {
        total += parseFloat(add["Valor"] || 0);
      }
    });

    return total;
  };

  return (
    <div className="min-h-screen bg-[#F7F9FC] text-[#1A1A2E] p-6">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-4xl font-bold text-center text-[#1A237E] mb-6">
          Orçamento Vinicius Barbaro Films
        </h1>

        <div className="space-y-4">
          <h2 className="text-2xl font-semibold">Selecione os serviços:</h2>
          {services.map((service, idx) => (
            <div key={idx} className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={!!selectedServices[service["Serviço"]]}
                onChange={() => handleServiceToggle(service["Serviço"])}
              />
              <label>{service["Serviço"]}</label>
            </div>
          ))}
        </div>

        {isFilmingSelected && (
          <div className="mt-6 space-y-4">
            <h3 className="text-xl font-semibold">Tipos de Edição de Vídeo (obrigatório):</h3>
            {videoEditTypes.map((type, idx) => (
              <div key={idx} className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={selectedVideoEdits.includes(type["Tipo de Vídeo"])}
                  onChange={() => handleVideoEditToggle(type["Tipo de Vídeo"])}
                />
                <label>
                  {type["Tipo de Vídeo"]} - R$ {parseFloat(type["Valor"]).toFixed(2)}
                </label>
              </div>
            ))}

            <h3 className="text-xl font-semibold mt-4">Adicionais de Vídeo:</h3>
            {videoAdditionals.map((add, idx) => (
              <div key={idx} className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={selectedVideoAdditionals.includes(add["Serviço"])}
                  onChange={() => handleVideoAdditionalToggle(add["Serviço"])}
                />
                <label>
                  {add["Serviço"]} - R$ {parseFloat(add["Valor"]).toFixed(2)}
                </label>
              </div>
            ))}
          </div>
        )}

        <div className="mt-6 flex justify-between items-center border-t pt-4">
          <label htmlFor="providers" className="font-semibold">
            Quantidade de Fornecedores:
          </label>
          <input
            id="providers"
            type="number"
            min="1"
            max="10"
            value={providerCount}
            onChange={(e) => setProviderCount(e.target.value)}
            className="border p-1 w-20"
          />
        </div>

        <div className="mt-6 text-center">
          <h2 className="text-3xl font-bold text-[#0D47A1]">
            Total: R$ {calculateTotal().toFixed(2)}
          </h2>
        </div>

        <div className="mt-6 text-center">
          <Button disabled={isFilmingSelected && selectedVideoEdits.length === 0}>
            Próximo passo
          </Button>
        </div>
      </div>
    </div>
  );
}
